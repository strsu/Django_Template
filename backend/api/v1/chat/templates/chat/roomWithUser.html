<!-- chat/templates/chat/room.html -->
<!DOCTYPE html>

{% load static %}
{% load sass_tags %}

<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
    <link rel="stylesheet" href="{% static 'chat/css/chat.css' %}">
    <link href="{% sass_src 'chat/css/chat.scss' %}" rel="stylesheet" type="text/css" />
</head>
<body>
    <!-- 모달 -->
	<div id="myModal" class="modal">
		<div class="modal-content">
            <div style="display: flex; flex-direction: column;" onclick="closeModal()">
                <img id="img-modal" style="width: 100%" onclick="closeModal()"/>
            </div>
			
		</div>
	</div>

    <div id="container">
        <div id="chat-container">
            <div id="chat-user"></div>
            <div id="chat-log"></div>
            <div id="chat-input">
                <div id="chat-file">
                    <label className="input-file-button" for="filename" style="cursor: pointer !important;">
                        &#x1F4C2
                    </label>
                    <input type="file" id="filename" accept="image/*" style="display: none;" />
                </div>
                <div id="chat-content">
                    <input id="chat-message-input" type="text" size="100">
                </div>
                <div id="chat-send">
                    <input id="chat-message-submit" type="button" value="&#x1F6AC">
                </div>
            </div>
            <div id="preview"><img id="preview-img"/><button onclick="closeBtn()">X</button></div>
        </div>
        <div id="update">
            <table style="margin-bottom: 10px;"> 
                <thead> <tr> <th>Position</th> <th>Member</th> <th>Role</th> <th>Salary</th> </tr> </thead> 
                <tbody> 
                    <tr> <td>CEO</td> <td>박찎찎</td> <td>직원관리,백,데브옵스</td> <td> <strong>━</string>아아 4잔 - 7샷</td> </tr> 
                        <tr> <td>CTO</td> <td>진딱딱</td> <td>기술고문</td> <td>아아 1잔 - 2샷</td> </tr> 
                        <tr> <td>CCO(Chief Cleaner Officer)</td> <td>연경(배구선수)</td> <td>청소부 - 책상, 스파게티 코드 등</td> <td>아아 1잔 - 2샷</td> </tr> 
                        <tr> <td>CFO(Chief Frontend Officer)</td> <td>열애중~</td> <td>프론트</td> <td>아아 1잔 - 2샷</td> </tr> 
                        <tr> <td>Intern</td> <td>또 인턴</td> <td>채팅 Data 분석</td> <td>아아 1잔 - 1샷</td> </tr> 
                </tbody>
            </table>
            <table>
                <thead>
                    <tr>
                        <th>Will be..</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>gif 전송</td>
                    </tr>
                    <tr>
                        <td>파이썬 인터프리터</td>
                    </tr>
                    <tr>
                        <td>음식/술집/커피점 추천해줘</td>
                    </tr>
                    <tr>
                        <td>사다리/룰렛</td>
                    </tr>
                    <tr>
                        <td>포커/뿌요뿌요</td>
                    </tr>
                    <tr>
                        <td>마블 영화 제공</td>
                    </tr>
                    <tr>
                        <td></td>
                    </tr>
                </tbody>
    
            </table>
        </div>
    </div>
    

    <div style="margin-top: 20px;">
        <table>
            <thead>
                <tr>
                    <th>일시</th>
                    <th>작업내용</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>23.04.01</td>
                    <td>내 메세지 / 상대방 메세지 분리해서 표현</td>
                </tr>
                <tr>
                    <td>23.04.01</td>
                    <td>이미지 전송 기능 추가 -> resize해서 용량 줄여서</td>
                </tr>
                <tr>
                    <td>23.04.02</td>
                    <td>메세지 디자인, 시간 추가</td>
                </tr>
                <tr>
                    <td>23.04.02</td>
                    <td>현재 접속자 수 표시 -> redis로 했는데, 좀 부정확 함</br>(서버 다운되면 redis 초기화 해주는 기능 필요)</td>
                </tr>
                <tr>
                    <td>23.04.02</td>
                    <td>오늘 뭐 먹지 -> 음식추천해줌</td>
                </tr>
                <tr>
                    <td>23.04.04</td>
                    <td>오늘 뭐 먹지 -> 다음 검색 결과 표시</td>
                </tr>
                <tr>
                    <td>23.04.05</td>
                    <td>이미지 확대 기능</td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
            </tbody>

        </table>
    </div>

    <input type="file" id="filename2" />
    <button onclick="sendFile_bytes()" />

    {{ room_name|json_script:"room-name" }}
    {{ user_name|json_script:"user-name" }}
    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        const userName = JSON.parse(document.getElementById('user-name').textContent);

        function openModal(name) {
			document.getElementById("myModal").style.display = "block";
            document.getElementById("img-modal").src = document.getElementsByName(name)[0].src;
		}

		function closeModal() {
			document.getElementById("myModal").style.display = "none";
		}

        function generateRandomString(length) {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
              result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
          }

        document.cookie = `X-Authorization=${generateRandomString(10)}; path=/`;

        const info = {
            userCount: (data) => {
                document.getElementById('chat-user').innerText = `현재 접속 인원: ${data.user_cnt}`;
            }
        };

        const msg = {
            msg: (data) => {
                console.log(data);
                let log = document.querySelector('#chat-log');

                let chat = document.createElement("div");
                let usr = document.createElement("div");
                let msg_container = document.createElement("div");
                let msg = document.createElement("div");
                let time = document.createElement("div");
    
                if(data.flag) {
                    chat.id = "msg-container-my";
                    msg_container.id = "msg-inner-container-my";
                    msg.id = "msg-msg-my";
                } else {
                    chat.id = "msg-container";
                    msg_container.id = "msg-inner-container";
                    msg.id = "msg-msg";
                }
                
                usr.id = "msg-usr";
                usr.innerText = data.name;
                msg.innerText = data.message;
    
                const now = new Date(data.time);
                const hours = now.getHours().toString().padStart(2, 0);
                const minutes = now.getMinutes().toString().padStart(2, 0);
                time.innerText = `${hours}:${minutes}`;
                time.style.fontSize = "13px";
    
                chat.appendChild(usr);
    
                if(data.image) {
                    let img = document.createElement("img");
                    img.src = data.image;
                    img.id = "chat-img";
                    img.name = generateRandomString(10);
                    img.setAttribute("onclick", `openModal("${img.name}")`);
                    chat.appendChild(img);
    
                    if(!data.message) {
                        img.appendChild(time);
                    }
                }
    
                if(data.message) {
                    msg_container.appendChild(msg);
                    msg_container.appendChild(time);
                    chat.appendChild(msg_container);
                }
    
                log.appendChild(chat);
                log.scrollTop = log.scrollHeight + log.clientHeight; // msg오면 제일 하단으로 이동
            },
            food: (data) => {
                let log = document.querySelector('#chat-log');
                let container = document.createElement("div");
                let iframe = document.createElement("iframe");

                container.id = "msg-container";

                iframe.src = `https://search.daum.net/search?nil_suggest=btn&w=tot&DA=SBC&q=${data.message} 문정`;
                iframe.width = "460px";
                iframe.height = "400px";
                iframe.minHeight = "400px"
                
                container.appendChild(iframe);
                log.appendChild(container);
                log.scrollTop = log.scrollHeight + log.clientHeight; // msg오면 제일 하단으로 이동
            }
        }

        const sender = {
            msg: (obj) => {

                data = {
                    "data": {
                        'name': userName,
                        'message': obj.message,
                        "image": obj.image,
                        "time": new Date()
                    }    
                }
                chatSocket.send(JSON.stringify(data));
            }
        }

        const chatSocket = new WebSocket(
            'wss://'
            + window.location.host
            + '/ws/chat/'
            + roomName
            + '/'
            + userName
            + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            if(data.info) {
                info.userCount(data.info);
            } else if(data.msg) {
                msg.msg(data.msg);
            } else if(data.food) {
                msg.msg(data.food);
                msg.food(data.food);
            }
            
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly', e);
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;

            var file = document.getElementById('filename').files[0];
            if(file) {
                sendFile();
                return;
            }

            if (!message) {
                return;
            }

            sender.msg({
                'message': message,
            })
            messageInputDom.value = '';
        };

        function resizeImage(file, maxWidth, maxHeight, callback) {
            let reader = new FileReader();
            reader.onload = function() {
              let image = new Image();
              image.onload = function() {
                let canvas = document.createElement('canvas');
                let context = canvas.getContext('2d');
                let ratio = Math.min(maxWidth / image.width, maxHeight / image.height);
                canvas.width = image.width * ratio;
                canvas.height = image.height * ratio;
                context.drawImage(image, 0, 0, canvas.width, canvas.height);
                callback(canvas.toDataURL());
              };
              image.src = reader.result;
            };
            reader.readAsDataURL(file);
          }

        function sendFile() {
            var file = document.getElementById('filename').files[0];
            resizeImage(file, 500, 500, function(resizedImage) {
                const messageInputDom = document.querySelector('#chat-message-input');
                const message = messageInputDom.value;
                sender.msg({
                    'message': message,
                    "image": resizedImage,
                })
                messageInputDom.value = "";
                document.getElementById('filename').value = ''; // 전송 후 file 초기화
                document.getElementById("preview").style.display = "none";
              });
        }

        function sendFile_bytes() {
            function getExtension(filename) {
                var parts = filename.split('.');
                return parts[parts.length - 1];
            }

            var file = document.getElementById('filename2').files[0];
            var reader = new FileReader();
            var rawData = new ArrayBuffer();
            var extension = getExtension(file.name);

            reader.loadend = function() {
            }

            reader.onload = function(e) {
                rawData = e.target.result;
                
                // ArrayBuffer를 여러 개의 조각으로 분할하여 보내기
                var chunkSize = 10240; // 분할 크기
                var offset = 0;
                chatSocket.send(JSON.stringify({
                    "data": {
                        'name': userName,
                        'flag': 1,
                        "file": file.name,
                        "time": new Date()
                    }   
                }));
                while (offset < rawData.byteLength) {
                    var chunk = rawData.slice(offset, offset + chunkSize);
                    chatSocket.send(chunk); // 이걸루 보내면 bytes로 인식된다.
                    offset += chunkSize;
                }
                chatSocket.send(JSON.stringify({
                    "data": {
                        'name': userName,
                        'flag': 0,
                        "file": file.name,
                        "time": new Date()
                    }   
                }));
            }
            reader.readAsArrayBuffer(file);
        }

        function closeBtn() {
            document.getElementById("preview").style.display = "none";
            document.getElementById('filename').value = ''; // 전송 후 file 초기화
        }

        document.getElementById('filename').addEventListener('change', function(e) {
            if (e.target.files[0]) {
                document.getElementById("preview").style.display = "flex";
                resizeImage(e.target.files[0], 500, 500, function(resizedImage) {
                    document.getElementById("preview-img").src = resizedImage;
                  });
            }
        });

    </script>
</body>
</html>